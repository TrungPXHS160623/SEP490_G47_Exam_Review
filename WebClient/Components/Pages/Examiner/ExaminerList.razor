@page "/Examiner/ExamList"
<h1 style="text-align: center;">Exam List</h1>
<style>
    .mud-table-cell {
        border: none !important;
        text-align: center;
    }

    .mud-table-head .mud-table-row .mud-table-cell {
        border-bottom: 1px solid grey !important;
        font-size: 1.2rem;
    }

    .mud-table {
        box-shadow: none !important;
    }

    .mud-table-root {
        border-collapse: separate !important;
        border-spacing: 0 !important;
    }

    .mud-table-head .mud-table-row {
        box-shadow: 0 5px 10px #e1e5ee;
        position: sticky;
        top: 0;
        background-color: white;
        z-index: 99;
    }
</style>
<div class="d-flex justify-content-center">
    <div class="mt-4">
            <div class="d-flex align-items-center flex-wrap">
                <MudTextField @bind-Value="request.ExamCode" Label="Exam Code" Variant="Variant.Outlined" Margin="Margin.Dense" Class="me-4" Clearable></MudTextField>
                <MudSelect @bind-Value="request.StatusId"
                           Variant="Variant.Outlined"
                           Label="Status"
                           Margin="Margin.Dense"
                           AnchorOrigin="Origin.BottomCenter"
                           Clearable
                           Class="me-4 col-auto">
                    @if (statusList.Count > 0)
                    {
                        @foreach (var item in statusList)
                        {
                            <MudSelectItem T="int?" Value="item.ExamStatusId">@item.StatusContent</MudSelectItem>
                        }
                    }
                </MudSelect>

                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Search" OnClick="GetData">Search</MudButton>
            </div>
        <div class="custom-box">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h4>Exam List</h4>
                </div>
            </div>
            <div>
                @if (ExamList.Count > 0)
                {
                    int index = 1;
                    <MudTable T="ExaminerExamResponse" Items="ExamList" FixedHeader="true" Height="400px" Hover="true">
                        <HeaderContent>
                            <MudTh>#</MudTh>
                            <MudTh>Exam Code</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Head of Department</MudTh>
                            <MudTh>Exam Type</MudTh>
                            <MudTh>Review Start Date</MudTh>
                            <MudTh>Review End Date</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@((ExamList.IndexOf(@context) + 1))</MudTd>
                            <MudTd>@context.ExamCode</MudTd>
                            <MudTd>
                                <label class="fw-bold" style="color:@(ColorList[context.ExamStatusId.Value])">@context.ExamStatusContent</label>
                            </MudTd>
                            <MudTd>@context.HeadDepartmentName</MudTd>
                            <MudTd>@context.ExamType</MudTd>
                            <MudTd>@(context.StartDate.HasValue ? context.StartDate.Value.ToString("dd-MM-yyyy") : "N/A")</MudTd>
                            <MudTd>@(context.EndDate.HasValue ? context.EndDate.Value.ToString("dd-MM-yyyy") : "N/A")</MudTd>
                            <MudTd>
                                <div class="d-flex align-items-center justify-content-around">
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@(() => OpenAddEditDialogAsync(context.ExamId))">Detail</MudButton>
                                    <MudButton Color="Color.Secondary" Variant="Variant.Filled" Disabled="@(context.ExamStatusId != 5)">Report</MudButton>
                                </div>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                    index++;
                }
                else
                {
                    <p>No Data</p>
                }
            </div>
            <div class="mt-5 d-flex justify-content-between align-items-center">
                <div>
                    <MudButton Variant="Variant.Filled" OnClick="ExportAllExams" Color="Color.Surface">Export All</MudButton>
                </div>
                <div>
                    <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="AssignExam">Transfer Exam</MudButton>
                </div>
            </div>
        </div>
    </div>
</div>


@code {
    [CascadingParameter]
    public MainLayout Layout { get; set; }

    IList<IBrowserFile> _files = new List<IBrowserFile>();

    public List<ExaminerExamResponse> ExamList = new List<ExaminerExamResponse>();
    public List<ExaminerExamResponse> assignList = new List<ExaminerExamResponse>();

    public List<ExamStatus> statusList = new List<ExamStatus>();

    public ExamSearchRequest request = new();

    private Dictionary<int, string> ColorList = new Dictionary<int, string>
    {
        { 1, "#C0C0C0" }, // Not Assign
        { 2, "#FFD700" }, // Waiting to Assign
        { 3, "#1E90FF" }, // Assigned
        { 4, "#FFA500" }, // Reviewing
        { 5, "#32CD32" }, // Finish Review
        { 6, "#228B22" }, // Complete
        { 7, "#FF6347" }, // Cancel
    };

    protected override async Task OnInitializedAsync()
    {
        var isAuthenticated = await CustomAuthStateProvider.IsUserAuthenticated();

        if (isAuthenticated)
        {
            var auth = await CustomAuthStateProvider.GetAuthenticationStateAsync();
            var user = auth.User;
            var userId = int.TryParse(user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)?.Value, out var id) ? id : 0;

            var response = await MenuServive.CheckAccess(userId, 3);

            if (!response.IsSuccessful)
            {
                NavManager.NavigateTo("/404");
            }
            else
            {
                await GetData();

                var sList = await this.StatusServive.GetStatus();
                if (sList.IsSuccessful)
                {
                    statusList = sList.Items;
                }

                if (Layout != null)
                {
                    Layout.Header = "Home";
                    Layout.HeaderLink = "/Home";
                    Layout.SubHeader = "Exam Assign List";
                    Layout.RefreshLayout();
                }
            }
        }
    }

    private async Task OpenAddEditDialogAsync(int examId, bool isView = true)
    {
        var options = new DialogOptions
            {
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                BackdropClick = false,

            };

        var parameters = new DialogParameters<ExamDetail>
        {
            { x => x.IsView, isView },
            {x => x.ExamId,examId}
        };

        var dialog = await DialogService.ShowAsync<ExamDetail>(examId == 0 ? "Exam Create" : "Exam Detail", parameters, options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await GetData();
        }
    }

    private async Task OpenImportDialogAsync()
    {
        var options = new DialogOptions
            {
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.Small,
                FullWidth = true,
                BackdropClick = false,

            };

        var parameters = new DialogParameters<ImportDialog>();

        var dialog = await DialogService.ShowAsync<ImportDialog>("Import Exam", parameters, options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await GetData();
        }
    }

    private void UploadFiles(IBrowserFile file)
    {
        _files.Clear();
        _files.Add(file);
    }

    private async Task GetData()
    {
        var eList = await this.ExamServive.GetExamList(request);
        if (eList.IsSuccessful)
        {
            ExamList = eList.Items;
        }
    }

    private async Task AssignExam()
    {
        assignList = ExamList.Where(x => x.ExamStatusId == 1).Select(x => x).ToList();

        if (assignList.Count > 0)
        {
            var msg = CheckSelectedExam();

            if (msg.Length == 0)
            {
                var mailList = assignList.GroupBy(x => x.HeadDepartmentName).Select(x => x.Key).ToList();

                List<MailUtil> list = new();

                foreach (var item in mailList)
                {
                    var mail = new MailUtil
                        {
                            MailTo = item
                        };
                    list.Add(mail);
                }

                var mailModel = new MailModel
                    {
                        Body = "Đề thi đã được khảo thí chuyển cho các chủ nhiệm bộ môn. Chủ nhiệm bộ môn thực hiện việc assign cho các giảng viên để thực hiện test đề thi",
                        MailList = list,
                        Subject = "Assign đề thi cho chủ nhiệm bộ môn"
                    };

                var resp = await this.ExamServive.ChangeStatusExam(assignList.ToList());

                if (resp.IsSuccessful)
                {
                    var result = await this.MailServive.SendMail(mailModel);
                    await GetData();
                }
            }
            else
            {
                foreach (var item in msg)
                {
                    Snackbar.Add(item, Severity.Warning);
                }
            }
        }
    }

    public string[] CheckSelectedExam()
    {
        List<string> errors = new List<string>();

        var examsWithWrongStatus = assignList.Where(x => x.ExamStatusId != 1).ToList();
        foreach (var exam in examsWithWrongStatus)
        {
            errors.Add($"Exam {exam.ExamCode} is already assigned. Cannot Re-Assign!");
        }

        var examsWithMissingDates = assignList.Where(x => x.EndDate == null || x.StartDate == null).ToList();
        foreach (var exam in examsWithMissingDates)
        {
            errors.Add($"Exam {exam.ExamCode} has Start Date or End Date not chosen yet.");
        }

        var examsWithMissingHead = assignList.Where(x => x.HeadDepartmentId == null).ToList();
        foreach (var exam in examsWithMissingHead)
        {
            errors.Add($"Exam {exam.ExamCode} has no subject leader yet.");
        }

        return errors.ToArray();
    }
    private async Task ExportAllExams()
    {
        var response = await this.ExamServive.ExportAllExams();

        if (response != null && response.IsSuccessful)
        {
            try
            {
                using var stream = new MemoryStream(response.Item);
                var fileUrl = $"data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,{Convert.ToBase64String(stream.ToArray())}";
                await js.InvokeVoidAsync("open", fileUrl);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error during file download: {ex.Message}", Severity.Error);
            }
        }
        else
        {
            Snackbar.Add("Error exporting exams.", Severity.Error);
        }
    }


}